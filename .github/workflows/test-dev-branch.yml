name: Test Development Branch - Both Build Modes

on:
  push:
    branches:
      - dev
      - 'refactor/**'
      - 'feature/**'
  pull_request:
    branches:
      - main
      - dev

jobs:
  test-development-mode:
    name: Test Development Build Mode
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up environment variables
        run: |
          echo "SECRET_KEY=test-secret-key-for-ci" >> $GITHUB_ENV
          echo "PLAID_CLIENT_ID=test-client-id" >> $GITHUB_ENV
          echo "PLAID_SECRET=test-secret" >> $GITHUB_ENV
          echo "PLAID_ENV=sandbox" >> $GITHUB_ENV
      
      - name: Create .env file for Docker Compose
        run: |
          cat << EOF > .env
          SECRET_KEY=test-secret-key-for-ci
          PLAID_CLIENT_ID=test-client-id
          PLAID_SECRET=test-secret
          PLAID_ENV=sandbox
          EOF
      
      - name: Build and start services (Development Mode)
        run: |
          docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d --build
          echo "Services started in development mode with hot reload configuration"
      
      - name: Wait for services to be healthy
        run: |
          chmod +x scripts/ci/wait-for-services.sh
          ./scripts/ci/wait-for-services.sh
      
      - name: Test API root endpoint
        run: |
          response=$(curl -s http://localhost:8000/)
          echo "API Response: $response"
          if [[ $response != *"Plaid Transaction Categorization API"* ]]; then
            echo "API root endpoint test failed"
            exit 1
          fi
          echo "✓ API root endpoint test passed"
      
      - name: Test frontend accessibility
        run: |
          # Test that frontend returns HTML
          response=$(curl -s http://localhost:3000/)
          if [[ ! $response =~ "<!DOCTYPE html>" ]] && [[ ! $response =~ "<html" ]]; then
            echo "Frontend does not return valid HTML"
            exit 1
          fi
          echo "✓ Frontend returns valid HTML"
      
      - name: Verify frontend is in development mode
        run: |
          # Check that dev server is running (not production server)
          LOGS=$(docker compose -f docker-compose.yml -f docker-compose.dev.yml logs frontend 2>&1)
          if echo "$LOGS" | grep -q "pnpm dev"; then
            echo "✓ Frontend is running development server (pnpm dev)"
          else
            echo "⚠ Warning: Could not confirm development server is running"
            echo "Frontend logs:"
            echo "$LOGS"
          fi
      
      - name: Show service logs on failure (Development)
        if: failure()
        run: |
          echo "=== Database Logs ==="
          docker compose logs db
          echo "=== API Logs ==="
          docker compose logs api
          echo "=== Frontend Logs ==="
          docker compose logs frontend
      
      - name: Cleanup development containers
        if: always()
        run: |
          docker compose -f docker-compose.yml -f docker-compose.dev.yml down -v

  test-production-mode:
    name: Test Production Build Mode
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up environment variables
        run: |
          echo "SECRET_KEY=test-secret-key-for-ci" >> $GITHUB_ENV
          echo "PLAID_CLIENT_ID=test-client-id" >> $GITHUB_ENV
          echo "PLAID_SECRET=test-secret" >> $GITHUB_ENV
          echo "PLAID_ENV=sandbox" >> $GITHUB_ENV
          echo "BUILD_MODE=production" >> $GITHUB_ENV
          echo "RESTART_POLICY=no" >> $GITHUB_ENV
          echo "FRONTEND_PORT=80" >> $GITHUB_ENV
      
      - name: Create .env file for Docker Compose
        run: |
          cat << EOF > .env
          SECRET_KEY=test-secret-key-for-ci
          PLAID_CLIENT_ID=test-client-id
          PLAID_SECRET=test-secret
          PLAID_ENV=sandbox
          BUILD_MODE=production
          RESTART_POLICY=no
          FRONTEND_PORT=80
          EOF
      
      - name: Build and start services (Production Mode)
        run: |
          BUILD_MODE=production RESTART_POLICY=no FRONTEND_PORT=80 docker compose up -d --build
          echo "Services started in production mode"
      
      - name: Wait for services to be healthy
        run: |
          chmod +x scripts/ci/wait-for-services.sh
          ./scripts/ci/wait-for-services.sh
      
      - name: Test API root endpoint
        run: |
          response=$(curl -s http://localhost:8000/)
          echo "API Response: $response"
          if [[ $response != *"Plaid Transaction Categorization API"* ]]; then
            echo "API root endpoint test failed"
            exit 1
          fi
          echo "✓ API root endpoint test passed"
      
      - name: Test frontend accessibility
        run: |
          # Test that frontend returns HTML
          response=$(curl -s http://localhost:3000/)
          if [[ ! $response =~ "<!DOCTYPE html>" ]] && [[ ! $response =~ "<html" ]]; then
            echo "Frontend does not return valid HTML"
            exit 1
          fi
          echo "✓ Frontend returns valid HTML"

      - name: Verify frontend build mode
        run: |
          # Check that nginx is running in the production container
          NGINX_STATUS=$(docker compose exec -T frontend sh -c "ps aux | grep 'nginx: master process' | grep -v grep" || echo "not_found")
          if [ "$NGINX_STATUS" = "not_found" ]; then
            echo "❌ ERROR: Nginx is not running in production container"
            echo "Container processes:"
            docker compose exec -T frontend ps aux
            exit 1
          else
            echo "✓ Nginx is running in production mode"
            echo "Nginx process: $NGINX_STATUS"
          fi
          
          # Verify nginx is serving on port 80
          NGINX_PORT=$(docker compose exec -T frontend sh -c "netstat -tln | grep ':80 ' || echo 'not_found'")
          if [ "$NGINX_PORT" = "not_found" ]; then
            echo "⚠ Warning: Could not confirm nginx is listening on port 80"
          else
            echo "✓ Nginx is listening on port 80"
          fi
          
          # Check that development server is NOT running
          LOGS=$(docker compose logs frontend 2>&1)
          if echo "$LOGS" | grep -q "pnpm dev"; then
            echo "❌ ERROR: Frontend is running development server (pnpm dev) instead of nginx"
            echo "Frontend logs:"
            echo "$LOGS"
            exit 1
          else
            echo "✓ Frontend is not running development server"
          fi
 
      
      - name: Show service logs on failure (Production)
        if: failure()
        run: |
          echo "=== Database Logs ==="
          docker compose logs db
          echo "=== API Logs ==="
          docker compose logs api
          echo "=== Frontend Logs ==="
          docker compose logs frontend
      
      - name: Cleanup production containers
        if: always()
        run: |
          docker compose down -v
