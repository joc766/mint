# Docker Troubleshooting Guide

## Common Issues and Solutions

### Issue: "next-env.d.ts anonymous volume error"

**Symptom**:
```
Error: ENOTDIR: not a directory, open '/app/next-env.d.ts'
```

**Root Cause**:
Docker attempted to mount `/app/next-env.d.ts` as an anonymous volume (directory), but `next-env.d.ts` is a file, not a directory. This causes a "not a directory" error.

**Solution**:

1. **Remove the anonymous volume** from `docker-compose.yml` and `docker-compose.override.yml`:
   
   ❌ **REMOVE THIS:**
   ```yaml
   volumes:
     - ./frontend:/app:cached
     - /app/node_modules
     - /app/.next
     - /app/next-env.d.ts  # ❌ Remove this line
   ```
   
   ✅ **CORRECT:**
   ```yaml
   volumes:
     - ./frontend:/app:cached
     - /app/node_modules
     - /app/.next
   ```

2. **Rebuild the container:**
   ```bash
   docker-compose down -v
   docker-compose build frontend
   docker-compose up
   ```

**Why this works:**
- `next-env.d.ts` is a TypeScript declaration file generated by Next.js
- It should be managed by the host (your editor) and shared via the main volume mount
- Creating an anonymous volume for it conflicts with the file mount

### Issue: "Unknown system error -35" on macOS

**Symptom**:
```
Error: Unknown system error -35: Unknown system error -35, open '/app/next-env.d.ts'
```

**Root Cause**:
This error occurs on macOS when Docker Desktop has file system sync conflicts between the host and container. Error code `-35` (EAGAIN) happens when:
1. Docker volumes mount the entire source directory (`./frontend:/app`)
2. Next.js tries to write generated files (`next-env.d.ts`, `.next` cache)
3. File system sync between host and container conflicts on write operations

**Solution Applied**:

1. **Delegated Volume Mount**: Added `:delegated` flag to prioritize container writes
   ```yaml
   - ./frontend:/app:delegated
   ```
   This tells Docker to write to the container first and sync to the host asynchronously.

2. **Exclude Generated Files**: Added anonymous volumes for generated files
   ```yaml
   - /app/node_modules
   - /app/.next
   - /app/next-env.d.ts
   ```
   This prevents host files from conflicting with container-generated files.

3. **Proper Permissions**: Updated Dockerfile to ensure write permissions
   ```dockerfile
   RUN mkdir -p .next && chmod -R 777 .next
   ```

**How to Apply**:

1. Stop all running containers:
   ```bash
   docker-compose down
   ```

2. Remove old volumes (optional but recommended):
   ```bash
   docker-compose down -v
   ```

3. Rebuild the frontend container:
   ```bash
   docker-compose build frontend
   ```

4. Start the services:
   ```bash
   docker-compose up
   ```

### Performance: Volume Mount Modes on macOS

Docker Desktop on macOS supports three volume mount consistency modes:

- **`consistent`** (default): Perfect consistency between host and container (SLOWEST)
- **`cached`**: Host's view is authoritative, container updates async (RECOMMENDED for development)
- **`delegated`**: Container's view is authoritative, host updates async (good for write-heavy workloads)

**For Next.js hot reload, we use `:cached`** because:
- The development server (container) reads files frequently from the mounted volume
- Your editor (host) writes the files when you save changes
- Fast read performance is critical for hot reload responsiveness
- The container needs to detect file changes quickly
- Slight delay in container-to-host sync is acceptable in development

**Why not `:delegated`?**
- `:delegated` is optimized for containers that write frequently
- In development mode, the host (your editor) is the primary writer
- The container primarily reads files to detect changes and recompile
- Using `:delegated` would slow down file change detection

### Alternative: Run Without Docker

If Docker issues persist, you can run the frontend directly on your host:

```bash
cd frontend
pnpm install
pnpm dev
```

Make sure to set the API URL in your environment:
```bash
export NEXT_PUBLIC_API_URL=http://localhost:8000
pnpm dev
```

### Verifying the Fix

After applying the fix, you should see:

```bash
docker-compose up frontend
```

Expected output:
```
expense-tracker-app  | ▲ Next.js 14.2.25
expense-tracker-app  | - Local:        http://localhost:3000
expense-tracker-app  | - Network:      http://0.0.0.0:3000
expense-tracker-app  |
expense-tracker-app  | ✓ Ready in 3s
```

### Additional Resources

- [Docker Volume Performance on macOS](https://docs.docker.com/desktop/mac/)
- [Next.js Docker Documentation](https://nextjs.org/docs/deployment/docker)
- [Volume Mount Options](https://docs.docker.com/storage/bind-mounts/#configure-mount-consistency)

## Other Common Docker Issues

### Issue: "Port 3000 already in use"

**Solution**:
```bash
# Find process using port 3000
lsof -ti:3000

# Kill the process
kill -9 $(lsof -ti:3000)

# Or change the port in docker-compose.yml
ports:
  - "3001:3000"  # Maps host 3001 to container 3000
```

### Issue: "ENOSPC: System limit for number of file watchers reached"

**Solution** (Linux only):
```bash
echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

On macOS, this is not an issue due to different file watching mechanisms.

### Issue: Slow Build Times

**Solutions**:

1. Enable BuildKit (usually default on Docker Desktop):
   ```bash
   export DOCKER_BUILDKIT=1
   docker-compose build
   ```

2. Use layer caching effectively (already configured in Dockerfile)

3. Increase Docker Desktop resources:
   - Docker Desktop → Settings → Resources
   - Increase CPUs to 4+
   - Increase Memory to 4GB+

### Issue: Hot Reload Not Working

**Symptoms**:
- You save a file but changes don't appear in the browser
- No recompilation messages in container logs
- Browser doesn't automatically refresh

**Root Cause**:
Hot reload in Docker requires file watching with polling mode because Docker's virtualization layer breaks native file system events.

**Solution**:

1. **Ensure file watching environment variables are set** in `docker-compose.yml`:
   ```yaml
   environment:
     - WATCHPACK_POLLING=true
     - CHOKIDAR_USEPOLLING=true
   ```

2. **Verify webpack polling is configured** in `frontend/next.config.mjs`:
   ```javascript
   webpack: (config, { dev, isServer }) => {
     if (dev && !isServer) {
       config.watchOptions = {
         poll: 1000,
         aggregateTimeout: 300
       };
     }
     return config;
   }
   ```

3. **Verify volume mounts use `:cached` mode**:
   ```yaml
   volumes:
     - ./frontend:/app:cached  # Note the :cached flag
     - /app/node_modules
     - /app/.next
   ```

4. **Test hot reload**:
   ```bash
   # Watch the logs in one terminal
   docker-compose logs -f frontend
   
   # In another terminal, make a change
   echo "// test change" >> frontend/app/page.tsx
   
   # You should see compilation messages in the logs
   ```

5. **Restart the container** if environment variables were changed:
   ```bash
   docker-compose down
   docker-compose up -d
   ```

**Verification Steps**:

```bash
# Check environment variables are set
docker-compose exec frontend env | grep -E "WATCH|CHOKIDAR"

# Should output:
# WATCHPACK_POLLING=true
# CHOKIDAR_USEPOLLING=true
```

**For detailed hot reload troubleshooting, see [HOT_RELOAD.md](./HOT_RELOAD.md)**

### Issue: Changes Not Reflecting in Container

**Causes**:
- Volume not mounted correctly
- Hot reload not working (see above)
- Browser cache

**Solutions**:

1. Verify volume mounts:
   ```bash
   docker-compose config | grep -A 5 volumes
   ```

2. Hard refresh browser: `Cmd+Shift+R` (macOS) or `Ctrl+Shift+R` (Windows/Linux)

3. Restart with clean slate:
   ```bash
   docker-compose down
   docker-compose up --build
   ```

4. Check logs for compilation errors:
   ```bash
   docker-compose logs -f frontend
   ```

## Getting Help

If you continue to experience issues:

1. Check Docker Desktop is running and up-to-date
2. Review logs: `docker-compose logs frontend`
3. Try running without Docker to isolate the issue
4. Check [Docker Desktop Known Issues](https://docs.docker.com/desktop/mac/troubleshoot/)
